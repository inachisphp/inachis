#!/usr/bin/env bash
set -e

# Detect PHP files staged for commit
STAGED_PHP_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.php$' || true)

# Skip if no PHP files staged
if [ -z "$STAGED_PHP_FILES" ]; then
    echo "âœ… No PHP files staged â€” skipping PHPCBF."
    exit 0
fi

echo "ðŸ§¹ Running PHPCBF (auto-fixer) on staged PHP files..."

# Run PHPCBF with your project-specific ruleset
vendor/bin/phpcbf --standard=phpcbf.xml --no-patch $STAGED_PHP_FILES > /dev/null || true

# Re-add fixed files to the commit
echo "$STAGED_PHP_FILES" | while read -r file; do
    if [ -f "$file" ]; then
        git add "$file"
    fi
done

echo "âœ¨ PHPCBF complete. All staged PHP files are clean and formatted!"